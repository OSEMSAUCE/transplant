<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format Detection Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .results {
            margin-top: 20px;
        }
        .examples {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .example-btn {
            background-color: #2196F3;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Format Detection Tester</h1>
    
    <p>Enter comma-separated values to test, or choose one of the examples below:</p>
    
    <div class="examples">
        <button class="example-btn" onclick="loadExample('dates')">Date Examples</button>
        <button class="example-btn" onclick="loadExample('numbers')">Number Examples</button>
        <button class="example-btn" onclick="loadExample('mixed')">Mixed Examples</button>
        <button class="example-btn" onclick="loadExample('edge')">Edge Cases</button>
    </div>
    
    <textarea id="input-values" placeholder="Enter comma-separated values, e.g.: 2022-01-01, ES, 12/12/2020, France, 1999, 2025-05-10, 48.123,-122.456, 123, foo"></textarea>
    
    <button onclick="testValues()">Test Values</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div class="results">
        <h2>Results:</h2>
        <pre id="results-output"></pre>
    </div>

    <script>
        // Copy of your detection functions (converted to plain JS)
        function isNumber(value) {
            // Check if value is already a number
            if (typeof value === 'number') {
                return true;
            }

            if (typeof value === 'string') {
                // Remove commas, whitespace, and currency symbols
                const cleaned = value.replace(/[,\s€$£]/g, '').trim();
                // Check if it's a valid number string (including scientific notation)
                return /^-?\d+(\.\d+)?(e-?\d+)?$/.test(cleaned);
            }
            return false;
        }

        function isDate(value) {
            if (typeof value === 'number') {
                // Check if it's a valid year
                return 1900 < value && value < 2040;
            }
            if (typeof value === 'string') {
                // Check if it's a standalone year
                if (/^\d{4}$/.test(value)) {
                    const year = parseInt(value);
                    return 1900 < year && year < 2040;
                }

                // Check other date formats
                const DATE_FORMATS = [
                    /^\d{4}-\d{2}-\d{2}$/, // YYYY-MM-DD (ISO)
                    /^\d{4}\/\d{2}\/\d{2}$/, // YYYY/MM/DD
                    /^\d{4}\.\d{2}\.\d{2}$/, // YYYY.MM.DD
                    /^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}$/i, // Month YYYY
                    /^\d{1,2}\s+(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}$/i, // DD Month YYYY
                    /^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},\s+\d{4}$/i, // Month DD, YYYY
                    /^\d{1,2}-(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{4}$/i, // DD-MMM-YYYY
                    /^\d{1,2} (?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) \d{4}$/i, // DD MMM YYYY
                    /^\d{4}-(?:Q[1-4])$/, // YYYY-Q[1-4] (Quarter)
                    /^\d{4}-W(?:0[1-9]|[1-4][0-9]|5[0-3])$/, // YYYY-W[01-53] (ISO week)
                    /\b(19|20)\d{2}\s+(January|February|March|April|May|June|July|August|September|October|November|December)\b/, // Month YYYY
                    /\b(19|20)\d{2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/, // MMM YYYY
                    /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}$/i, // MMM YYYY
                    /\b(January|February|March|April|May|June|July|August|September|October|November|December)\b/, // Month
                    /^\d{1,2}(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\d{4}$/i,
                    /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY or DD/MM/YYYY
                    /^\d{2}-\d{2}-\d{4}$/ // MM-DD-YYYY or DD-MM-YYYY
                ];
                return DATE_FORMATS.some((format) => format.test(value));
            }
            return false;
        }

        function isGps(value) {
            if (typeof value === 'string') {
                const parts = value.split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    return (
                        !isNaN(lat) && !isNaN(lon) &&
                        lat >= -90 && lat <= 90 &&
                        lon >= -180 && lon <= 180
                    );
                }
            }
            return false;
        }

        function detectFormat(columnData, currentColumnHeader) {
            console.log('Checking column format for:', currentColumnHeader);
            // Reset detected format for new column
            let selectedFormat = 'string';
            const sampleValues = columnData
                .filter((val) => val !== null && val !== '')
                .slice(0, 3); // Get first 3 non-empty values
            
            // Count numbers in sample
            const numberCount = sampleValues.filter(isNumber).length;
            const dateCount = sampleValues.filter(isDate).length;

            // If majority format
            if (dateCount >= Math.ceil(sampleValues.length / 2)) {
                selectedFormat = 'date';
            } else if (numberCount >= Math.ceil(sampleValues.length / 2)) {
                selectedFormat = 'number';
            } else {
                console.log(
                    `No majority format - keeping as '${selectedFormat}' (${numberCount} numbers, ${dateCount} dates)`
                );
            }
            return selectedFormat;
        }

        // Test harness functions
        function testValues() {
            const input = document.getElementById('input-values').value;
            const values = input.split(',').map(v => v.trim());
            let output = '';
            
            output += 'Per-value detection:\n';
            values.forEach((val, idx) => {
                output += `[${idx}] "${val}": isDate=${isDate(val)}, isNumber=${isNumber(val)}, isGps=${isGps(val)}\n`;
            });
            
            const format = detectFormat(values, 'TestColumn');
            output += `\nColumn detectFormat: ${format}`;
            
            document.getElementById('results-output').textContent = output;
        }
        
        function clearResults() {
            document.getElementById('results-output').textContent = '';
        }
        
        function loadExample(type) {
            let values = [];
            
            switch(type) {
                case 'dates':
                    values = [
                        '2022-01-01', 
                        '12/12/2020', 
                        '1999', 
                        '2025-05-10',
                        'January 2023',
                        '15 March 2022',
                        'Apr 2021',
                        '2020-Q1',
                        '2019-W01'
                    ];
                    break;
                case 'numbers':
                    values = [
                        '123', 
                        '-456', 
                        '78.90', 
                        '1,234.56',
                        '$99.99',
                        '1.2e6',
                        '0',
                        '-0.5'
                    ];
                    break;
                case 'mixed':
                    values = [
                        '2022-01-01', 
                        'ES', 
                        '12/12/2020', 
                        'France', 
                        '1999', 
                        '2025-05-10', 
                        '48.123,-122.456', 
                        '123', 
                        'foo'
                    ];
                    break;
                case 'edge':
                    values = [
                        '0000',  // Not a valid year
                        '3000',  // Not a valid year
                        '123abc', 
                        'abc123',
                        '2022/13/01',  // Invalid month
                        '48.123',  // Not a GPS (missing lon)
                        '',
                        'null',
                        'undefined'
                    ];
                    break;
            }
            
            document.getElementById('input-values').value = values.join(', ');
        }
    </script>
</body>
</html>
